#!/bin/bash
if [ $# != "3" ]; then
  echo "Usage: mkverison major minor micro"
  exit;
fi

DATE=`date +"%d %B %Y"`
YEAR=`date +%Y`

cat > src/version.h << EOF
/* Automatically generated by mkversion */

#define MAJOR           $1
#define MINOR           $2
#define MICRO           $3
#define VERSION_STRING  "$1.$2.$3"
#define RELEASE_DATE    "$DATE"

#ifndef BUILD_DATE
#define BUILD_DATE      "$DATE"
#endif

#ifndef __VERSION_H__
#define __VERSION_H__

#ifdef __cplusplus
extern "C" {
#endif

extern char version_string[];
extern char release_date[];
extern char build_date[];

#ifdef __cplusplus
};
#endif

#endif 
EOF

cat > src/version.c << EOF
/* Automatically generated with mkversion3 */

#include "version.h"

#ifdef __cplusplus
extern "C" {
#endif

char version_string[] = "      Version: $1.$2.$3";
char release_date[]   = " Release Date: $DATE";
char build_date[]     = "   Build Date: " BUILD_DATE;

#ifdef __cplusplus
};
#endif
EOF

./scripts/msi-chver Installer/Installer $1 $2 $3

if [ -f doc/html/book.xml.in ]; then
  sed "s/@PUBDATE@/$DATE/g;s/@MAJOR@/$1/;s/@MINOR@/$2/;s/@MICRO@/$3/" doc/Users_Manual/book.xml.in > doc/Users_Manual/book.xml
fi

if [ -f scripts/tgz/SWFView.in ]; then
  sed "s/@MAJOR@/$1/;s/@MINOR@/$2/;s/@MICRO@/$3/" scripts/tgz/SWFView.in > scripts/tgz/SWFView
fi

if [ -f src/swfview.rc.in ]; then
  sed "s/@DATE@/$DATE/;s/@MAJOR@/$1/;s/@MINOR@/$2/;s/@MICRO@/$3/;s/@YEAR@/$YEAR/" src/swfview.rc.in > src/swfview.rc
fi

echo "$1.$2.$3" > scripts/tgz/SWFViewVersion

(pushd doc
  (pushd Users_Manual
publican rename --name=Users_Manual --version=$1.$2.$3)
make)

